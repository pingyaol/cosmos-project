---
title: "Lab-04c-capstone-prep"
author: "Pingyao Liu, Seoyoon Lee, Masha Kuritsyn"
date: "2024-07-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r initialization}
library(tidyverse)
library(ggplot2)
library(gtsummary)
library(dplyr)
library(lme4)
library(lmerTest)
library(psych)
library(rsample)
```

```{r dataImport}
data <- read.csv("../data/parkinsons_data.data")
glimpse(data) %>% head()
``` 

We took the mean of all the metrics and we will use this for further analysis before using more advanced models. 
```{r dataCleaning}

data <- data %>% mutate(sex = as.factor(sex))
data[, -c(1:6)] <- scale(data[, -c(1:6)])
colSums(data[,-c(1:6)])
apply(data, 2, sd)

mean_vals <- data %>% group_by(subject) %>% summarise(across(1: PPE, .fns = mean))
mean_vals
```

```{r, fig.width=8, fig.height=6}
updrs_plot <- ggplot(data, aes(x = test_time, y = total_UPDRS, group = subject, color = as.factor(sex))) + 
  scale_color_manual(values = c("dodgerblue4", "firebrick2")) + 
  geom_line() +
  labs(title = "Total UPDRS Over Test Time for Each Subject",
       x = "Test Time",
       y = "Total UPDRS",
       color = "Subject") +
  theme_minimal()

updrs_plot +
  theme(legend.position = "none")
```

This shows the relationship between age and total UPDRS score of PD patients.
```{r}
ggplot(data = mean_vals) +
  geom_point(aes(x = age, y = total_UPDRS), color = "violet") +
  labs(x = "Age", y = "Total UPDRS") +
  theme_minimal()
```

The dataset has 42 subjects, with 28 males and 14 females. Each subject had a different number of recordings, with the number ranging from 101 to 168. Due to the discrepancy between the number of recordings available to each subject, we decided to <INSERT PLAN HERE>. 


## Exploratory Data Analysis

```{r}
sub_counts <- group_by(data, subject) %>% count(subject)
sub_counts
```

```{r}
gender_count <- group_by(data, sex, subject) %>% count(sex)
gender_count
```

```{r}
ggplot(sub_counts, aes(x = subject, y = n)) +
  geom_point() +
  labs(title = "Scatterplot of subject vs number of recordings",
       x = "Subject",
       y = "N") +
  theme_minimal()
```

Scatterplot of mean total UPDRS scores of the 42 subjects 
```{r}
ggplot(data = mean_vals, aes(x = Jitter_Abs, y = total_UPDRS)) +
  geom_point(size = 1, color = "violet") +
  labs(x = "Absolute Jitters (microsecond)", y = "Total UPDRS") +
  theme_minimal()

```

``` {r}
lm(formula = total_UPDRS ~ Shimmer_dB, data = data) %>% 
    tbl_regression(estimate_fun = function(x) style_number(x, digits = 3))
```

```{r}
ggplot(data = mean_vals, aes(x = age, y = total_UPDRS)) +
  geom_point(size = 1, color = "violet") +
  labs(x = "Age", y = "Total UPDRS") +
  theme_minimal()
```
Shimmer vs total UPDRS 
```{r}
data %>% 
  mutate(subject = as.factor(subject)) %>% 
  ggplot(aes(x = Shimmer, y = total_UPDRS)) + 
  geom_point(size = 1, aes(color = subject)) + 
  labs(x = "Shimmer", y = "Total UPDRS") + 
  theme_minimal() 
```
Shimmer dB vs total UPDRS 
```{r}
data %>% 
  mutate(subject = as.factor(subject)) %>% 
  ggplot(aes(x = Shimmer_dB, y = total_UPDRS)) + 
  geom_point(size = 1, aes(color = subject)) + 
  labs(x = "Shimmer (dB)", y = "Total UPDRS") + 
  theme_minimal() 
```

Shimmer_APQ3 vs total UPDRS 
```{r}
data %>% 
  mutate(subject = as.factor(subject)) %>% 
  ggplot(aes(x = Shimmer_APQ3, y = total_UPDRS)) + 
  geom_point(size = 1, aes(color = subject)) + 
  labs(x = "Shimmer (dB)", y = "Total UPDRS") + 
  theme_minimal() 
```

Shimmer_APQ5 vs total UPDRS 
```{r}
data %>% 
  mutate(subject = as.factor(subject)) %>% 
  ggplot(aes(x = Shimmer_APQ5, y = total_UPDRS)) + 
  geom_point(size = 1, aes(color = subject)) + 
  labs(x = "Shimmer APQ5", y = "Total UPDRS") + 
  theme_minimal() 
```

Shimmer_APQ11 vs total UPDRS 
```{r}
data %>% 
  mutate(subject = as.factor(subject)) %>% 
  ggplot(aes(x = Shimmer_APQ11, y = total_UPDRS)) + 
  geom_point(size = 1, aes(color = subject)) + 
  labs(x = "Shimmer APQ 11", y = "Total UPDRS") + 
  theme_minimal() 
```

Shimmer_DDA vs total UPDRS 
```{r}
data %>% 
  mutate(subject = as.factor(subject)) %>% 
  ggplot(aes(x = Shimmer_DDA, y = total_UPDRS)) + 
  geom_point(size = 1, aes(color = subject)) + 
  labs(x = "Shimmer DDA", y = "Total UPDRS") + 
  theme_minimal() 
```


```{r}
model_UPDRS <- glm(total_UPDRS ~ sex, data = data)
model_UPDRS
attach(mean_vals)
range(mean_vals$total_UPDRS)
```

```{r}
# plot(mean_vals$total_UPDRS, mean_vals$sex, pch = 16, xlab = "Sex", ylab = "Total UPDRS")
```

``` {r}
lm(formula = total_UPDRS ~ Shimmer_dB, data = data) %>% 
    tbl_regression(estimate_fun = function(x) style_number(x, digits = 3))
```

```{r}
ggplot(data = mean_vals, aes(x = age, y = total_UPDRS)) +
  geom_point(size = 1, color = "violet") +
  labs(x = "Age", y = "Total UPDRS") +
  theme_minimal()
```

<!-- ```{r} -->
<!-- model_UPDRS <- glm(sex ~ total_UPDRS, data = mean_vals) -->
<!-- model_UPDRS -->
<!-- attach(mean_vals) -->
<!-- range(mean_vals$total_UPDRS) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- plot(mean_vals$total_UPDRS, mean_vals$sex, pch = 16, xlab = "Sex", ylab = "Total UPDRS") -->
<!-- ``` -->

``` {r}
lm(formula = total_UPDRS ~ Shimmer_dB, data = data) %>% 
    tbl_regression(estimate_fun = function(x) style_number(x, digits = 3))
```

```{r}
ggplot(data = mean_vals, aes(x = age, y = total_UPDRS)) +
  geom_point(size = 1, color = "violet") +
  labs(x = "Age", y = "Total UPDRS") +
  theme_minimal()
```

# ```{r}
# model_UPDRS <- glm(sex ~ total_UPDRS, data = mean_vals)
# model_UPDRS
# attach(mean_vals)
# range(mean_vals$total_UPDRS)
# ```

<!-- ```{r} -->
<!-- plot(mean_vals$total_UPDRS, mean_vals$sex, pch = 16, xlab = "Sex", ylab = "Total UPDRS") -->
<!-- ``` -->

```{r}
ggplot(sub_counts, aes(x = subject, y = n)) +
  geom_point() +
  labs(title = "Scatterplot of subject vs number of recordings",
       x = "Subject",
       y = "N") +
  theme_minimal()
```

<!-- ```{r} -->
<!-- model_lmer_all_factors <- lmer(total_UPDRS ~ Jitter_percent + Jitter_Abs + Jitter_RAP + Jitter_PPQ5 + Jitter_DDP + Shimmer + Shimmer_dB + Shimmer_APQ3 + Shimmer_APQ5 + Shimmer_APQ11 + Shimmer_DDA + NHR + HNR + RPDE + DFA + PPE + (1 + test_time | subject), data = data) -->
<!-- model_lmer_all_factors -->
<!-- summary(model_lmer_all_factors) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- model_lmer_voice <- lmer(total_UPDRS ~ Jitter_percent + Jitter_Abs + Jitter_RAP + Jitter_PPQ5 + Jitter_DDP + Shimmer + Shimmer_dB + Shimmer_APQ3 + Shimmer_APQ5 + Shimmer_APQ11 + Shimmer_DDA + (1 + Jitter_percent | subject) + (1 + Jitter_Abs | subject)  + (1 + Jitter_RAP | subject) + (1 + Jitter_PPQ5 | subject) + (1 + Jitter_DDP | subject) + (1 + Shimmer | subject) + (1 + Shimmer_dB | subject) + (1 + Shimmer_APQ3 | subject) + (1 + Shimmer_APQ5 | subject) + (1 + Shimmer_APQ11 | subject) + (1 + Shimmer_DDA | subject) + (1 + test_time | subject), data = data, control = lmerControl(calc.derivs = F)) -->
<!-- model_lmer_voice -->
<!-- summary(model_lmer_voice) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- model_lmer_dynamic <- lmer(total_UPDRS ~ NHR + HNR + RPDE + DFA + PPE + (1 + NHR | subject) + (1 + HNR | subject) + (1 + RPDE | subject) + (1 + DFA | subject) + (1+ PPE | subject) + (1 + test_time | subject), data = data) -->
<!-- model_lmer_dynamic -->
<!-- summary(model_lmer_dynamic) -->
<!-- ``` -->

TODO: population average trend, plot individual changes 

```{r, fig.width=20, fig.height=10}
pairs.panels(data[, c(7:17)], method = "pearson", hist.col = "blue", density = T, ellipses = T)
```

```{r}
set.seed(0)

data_split <- initial_split(data, prop = 0.7)

training_data <- training(data_split)
testing_data <- testing(data_split)
```

```{r}
lm_model <- lm(total_UPDRS ~ Jitter_percent + Jitter_Abs + Jitter_RAP + Jitter_PPQ5 + Jitter_DDP + Shimmer + Shimmer_dB + Shimmer_APQ3 + Shimmer_APQ5 + Shimmer_APQ11 + Shimmer_DDA, data = training_data, control = lmerControl(calc.derivs = F))
summary(lm_model)
```

```{r}
lm(total_UPDRS ~ Jitter_percent + Jitter_Abs + Jitter_RAP + Jitter_PPQ5 + Jitter_DDP + Shimmer + Shimmer_dB + Shimmer_APQ3 + Shimmer_APQ5 + Shimmer_APQ11 + Shimmer_DDA, data = training_data) %>%
  tbl_regression(estimate_fun = function(x) style_number(x, digits = 3))
```

```{r}
predictions <- predict(lm_model, newdata = testing_data)
mean((testing_data$total_UPDRS - predictions)^2)
```
